<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Business Platforms — Process Flow Builder</title>
<style>
:root{
  --p1:#7cc6ff; --p2:#5e87b5; --p3:#272e51; --bg:#f5f7fa;
  --panel: #ffffff; --muted:#5b667a; --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.12);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:#0f172a}

/* Top Bar */
.top{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--p3)}
.brand .bp{display:inline-flex;align-items:center;justify-content:center;width:40px;height:28px;border-radius:8px;background:linear-gradient(180deg,var(--p3),#0f1736);color:var(--p1)}
.client{margin-left:auto;display:flex;gap:8px;align-items:center}
.client input[type=text]{border:1px solid #cbd5e1;border-radius:8px;padding:8px;min-width:200px}
.client .btn{border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}

/* Layout */
.app{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;height:calc(100% - 60px)}
.board{position:relative;border:1px solid #dde3ef;border-radius:var(--radius);background:
  linear-gradient(0deg, rgba(255,255,255,.96), rgba(255,255,255,.96)),
  repeating-linear-gradient(0deg, transparent, transparent 29px, #e6edf7 30px),
  repeating-linear-gradient(90deg, transparent, transparent 29px, #e6edf7 30px);
  box-shadow:var(--shadow);min-height:820px;overflow:hidden}
.board.connecting{cursor:crosshair}
.board.connecting .port{opacity:1;box-shadow:0 0 0 2px rgba(124,198,255,.45)}
.board.connecting .port.hit{transform:translate(-50%,-50%) scale(1.2);outline:2px solid #fff}

/* LAYER LINES */
.layers{position:absolute;inset:0;pointer-events:none}
.layer{position:absolute;left:0;right:0;border-top:2px dashed var(--p2);opacity:.9}
.layer-label{position:absolute;left:10px;top:-14px;background:#fff;color:var(--p3);font-weight:800;border:1px solid #d7dfef;border-radius:999px;padding:4px 10px}

/* Connectors canvas */
svg.wires{position:absolute;inset:0;pointer-events:none}
.link{stroke:var(--p2);stroke-width:2;fill:none;opacity:.96;stroke-linecap:round;stroke-linejoin:round}
.link.dashed{stroke-dasharray:8 8}
.link.selected{filter:drop-shadow(0 0 0.35rem rgba(124,198,255,.9))}
.temp{stroke:var(--p1);stroke-width:2;fill:none;opacity:.6;stroke-dasharray:6 6}

/* Node cards */
#nodes{position:absolute;inset:0}
.node{position:absolute;min-width:210px;max-width:360px;background:#fff;border:1px solid #dde3ef;border-radius:12px;box-shadow:0 8px 20px rgba(15,23,42,.06);cursor:grab;user-select:none}
.node:active{cursor:grabbing;transform:scale(.985)}
.node .hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #eef2f8}
.node .hdr .nodeDel{margin-left:auto;border:1px solid #fecaca;color:#ef4444;background:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-weight:700}
.node .badge{font:700 11px/1 ui-sans-serif;color:#fff;background:var(--p2);border-radius:6px;padding:4px 6px}
.node .title{font-weight:700}
.node .body{padding:10px 12px;color:#334155}
.node .vendorRow{display:flex;align-items:center;gap:8px;margin-top:6px}
.node .vendorRow img{width:18px;height:18px;object-fit:contain;border-radius:4px;border:1px solid #e5e7eb}
.node select{border:1px solid #cbd5e1;border-radius:8px;padding:6px;font-size:12px}

/* Ports */
.ports{position:absolute;inset:0;pointer-events:none}
.port{position:absolute;width:12px;height:12px;border-radius:50%;background:var(--p1);box-shadow:0 0 0 2px rgba(0,0,0,.12);transform:translate(-50%,-50%);opacity:.9;transition:transform .15s ease, opacity .15s ease}
.port.hit{outline:2px solid #fff}
.port[data-side="top"]{top:0}
.port[data-side="bottom"]{top:100%}
.port[data-side="left"]{left:0}
.port[data-side="right"]{left:100%}

/* Floating Palette (draggable) */
.palette{position:absolute;right:16px;top:100px;background:var(--panel);border:1px solid #d7dfef;border-radius:12px;box-shadow:var(--shadow);width:320px;z-index:12}
.p-hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #e7eefb;cursor:move;background:linear-gradient(180deg,#fff,#f5f8ff)}
.p-body{padding:10px 12px;display:grid;gap:10px}
.block-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.block{border:1px dashed #c7d2e8;border-radius:10px;padding:8px 10px;background:#fff;display:flex;justify-content:space-between;align-items:center;cursor:grab}
.block small{color:#6b7280}
.p-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
.btn.primary{background:var(--p1);border-color:var(--p1);color:#0a0f1c;font-weight:700}

/* Link toolbar */
.linkbar{position:absolute;display:none;gap:6px;background:#fff;border:1px solid #d7dfef;border-radius:10px;box-shadow:var(--shadow);padding:6px;z-index:30}
.linkbar .btn{padding:4px 8px}
.linkbar .danger{border-color:#ef4444;color:#ef4444}

/* Print (PDF) */
@media print{
  .top,.palette,.linkbar{display:none!important}
  .board{box-shadow:none;border:none}
}
/* Selection & lasso */
.node.selected{outline:2px solid var(--p1); box-shadow:0 0 0 4px rgba(124,198,255,.12)}
.lasso{position:absolute;border:2px dashed var(--p1);background:rgba(124,198,255,.15);pointer-events:none;display:none;z-index:15}

</style>
</head>
<body>
  <div class="top">
    <div class="brand"><span class="bp">BP</span> Business Platforms</div>
    <div class="client">
      <input id="clientName" type="text" placeholder="Client...">
      <input id="clientLogo" type="file" accept="image/*" class="btn">
      <button id="clearBoard" class="btn">Clear board</button>
      <button id="exportPDF" class="btn">Export PDF</button>
      <button id="exportPNG" class="btn">Export PNG</button>
      <button id="exportSVG" class="btn">Export SVG</button>
      <button id="exportJSON" class="btn">Export JSON</button>
      <input id="importJSONFile" type="file" accept="application/json" style="display:none">
      <button id="importJSON" class="btn">Import JSON</button>
    </div>
  </div>

  <div class="app">
    <div class="board" id="board">
      <!-- layers -->
      <div class="layers" id="layerLines"></div>
      <svg id="wires" class="wires"></svg>
      <div id="nodes"></div>

      <!-- Floating Palette -->
      <div id="palette" class="palette">
        <div id="palHdr" class="p-hdr">Blocks (drag & drop)</div>
        <div class="p-body">
          <div class="block-grid" id="blocks"></div>
          <div class="p-row" style="justify-content:space-between">
            <div class="p-row">
              <button id="alignLeft" class="btn">Align L</button>
              <button id="alignTop" class="btn">Align T</button>
              <button id="alignVCenter" class="btn">Align V-Center</button>
              <button id="alignHCenter" class="btn">Align H-Center</button>
              <button id="distH" class="btn">Distribute H</button>
              <button id="distV" class="btn">Distribute V</button>
            </div>
            <button id="resetView" class="btn">Center view</button>
          </div>
        </div>
      <div id="lasso" class="lasso"></div>
      <!-- Link toolbar -->
      <div id="linkbar" class="linkbar">
        <button class="btn" data-act="toggle">Solid/Dashed</button>
        <button class="btn" data-act="none">No arrows</button>
        <button class="btn" data-act="start">Arrow ◀︎</button>
        <button class="btn" data-act="end">Arrow ▶︎</button>
        <button class="btn" data-act="both">⇄ Both</button>
        <button class="btn danger" data-act="delete">Delete</button>
      </div>
    </div>
  </div>

<script>
/* ======== State ======== */
const board=document.getElementById('board');
const nodesEl=document.getElementById('nodes');
const wires=document.getElementById('wires');
const palette=document.getElementById('palette');
const palHdr=document.getElementById('palHdr');
const linkbar=document.getElementById('linkbar');
const clientName=document.getElementById('clientName');
const clientLogo=document.getElementById('clientLogo');
const exportJSON=document.getElementById('exportJSON');
const importJSON=document.getElementById('importJSON');
const importJSONFile=document.getElementById('importJSONFile');
const exportPDF=document.getElementById('exportPDF');
const exportPNG=document.getElementById('exportPNG');
const exportSVG=document.getElementById('exportSVG');
const alignLeft=document.getElementById('alignLeft');
const alignTop=document.getElementById('alignTop');
const alignVCenter=document.getElementById('alignVCenter');
const alignHCenter=document.getElementById('alignHCenter');
const distH=document.getElementById('distH');
const distV=document.getElementById('distV');
const resetView=document.getElementById('resetView');
const clearBoardBtn=document.getElementById('clearBoard');
const layerLines=document.getElementById('layerLines');
const blocksGrid=document.getElementById('blocks');

const STORAGE='bp_pf_builder_v1';
let state={ nodes:[], links:[], client:{name:'', logo:''} };
let selected=new Set(); // node ids

// Dynamic configuration defaults (layers, blocks, vendors)
const DEFAULT_LAYERS=[
  { label:'L4', position:0.20 },
  { label:'L3', position:0.45 },
  { label:'L2', position:0.70 },
  { label:'L1', position:0.90 }
];
const DEFAULT_BLOCKS=[
  { type:'ERP', description:'Enterprise', vendors:['SAP','Microsoft Dynamics','Oracle NetSuite','Epicor','SYSPRO'] },
  { type:'QMS/DMS', description:'Quality/Docs', vendors:['Veeva Vault','Dot Compliance','Qualio','MasterControl','Medidata'] },
  { type:'LMS', description:'Training', vendors:['talentlms','eloomi','nimble LMS','trainingpost','Levelup'] },
  { type:'LIMS', description:'Lab', vendors:['STARLIMS','Labware LIMS','LabVantage','Thermo Fisher LIMS','GenoFAB'] },
  { type:'MES', description:'Operations', vendors:['PAS-X','Syncade','PharmaSuite'] },
  { type:'LAB ELN', description:'Notebook', vendors:['Labguru','Labfolder','eLabJournal','SciCord','LabArchives'] },
  { type:'HISTORIAN', description:'Time-series', vendors:['AVEVA PI System','FactoryTalk Historian','Canary'] },
  { type:'CMMS', description:'Maintenance', vendors:[] },
  { type:'BMS', description:'Building', vendors:[] },
  { type:'PLC', description:'Control', vendors:['Siemens','Rockwell','Yokogawa'] },
  { type:'Standalone Equipment', description:'', vendors:[] },
  { type:'Standalone Lab Instruments', description:'', vendors:[] },
  { type:'Digital System', description:'', vendors:[] }
];

const VENDORS={};
let layersConfig=cloneLayers(DEFAULT_LAYERS);
let blockConfig=cloneBlocks(DEFAULT_BLOCKS);
resetVendorMap(blockConfig);

/* ======== Helpers ======== */
function cloneLayers(layers){
  return (Array.isArray(layers)?layers:[]).map(layer=>({
    label: layer?.label ?? layer?.id ?? '',
    position: typeof layer?.position==='number' ? layer.position : Number.parseFloat(layer?.position) || 0
  }));
}
function cloneBlocks(blocks){
  return (Array.isArray(blocks)?blocks:[]).map(block=>({
    type:block?.type || '',
    description:block?.description || '',
    vendors:Array.isArray(block?.vendors)?[...block.vendors]:[]
  })).filter(block=>block.type);
}
function resetVendorMap(blocks){
  Object.keys(VENDORS).forEach(key=>delete VENDORS[key]);
  blocks.forEach(block=>{
    if(Array.isArray(block.vendors) && block.vendors.length){
      VENDORS[block.type]=[...block.vendors];
    }
  });
}
function renderLayers(){
  if(!layerLines) return;
  layerLines.innerHTML='';
  layersConfig.forEach(layer=>{
    const line=document.createElement('div');
    line.className='layer';
    const pos=Math.min(1, Math.max(0, layer.position));
    line.style.top=(pos*100)+'%';
    if(layer.label){
      const label=document.createElement('span');
      label.className='layer-label';
      label.textContent=layer.label;
      line.appendChild(label);
    }
    layerLines.appendChild(line);
  });
}
function renderBlockPalette(){
  if(!blocksGrid) return;
  blocksGrid.innerHTML='';
  blockConfig.forEach(block=>{
    const el=document.createElement('div');
    el.className='block';
    el.dataset.type=block.type;
    el.innerHTML=block.description ? `${block.type} <small>${block.description}</small>` : block.type;
    blocksGrid.appendChild(el);
  });
  setupBlockInteractions();
}
async function loadExternalConfig(){
  try{
    const res=await fetch('config.json', {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const cfg=await res.json();
    if(Array.isArray(cfg.layers)){
      layersConfig=cloneLayers(cfg.layers);
    } else {
      layersConfig=cloneLayers(DEFAULT_LAYERS);
    }
    if(Array.isArray(cfg.blocks)){
      blockConfig=cloneBlocks(cfg.blocks);
      resetVendorMap(blockConfig);
    } else {
      blockConfig=cloneBlocks(DEFAULT_BLOCKS);
      resetVendorMap(blockConfig);
    }
  }catch(err){
    console.warn('Config load failed, using defaults', err);
    layersConfig=cloneLayers(DEFAULT_LAYERS);
    blockConfig=cloneBlocks(DEFAULT_BLOCKS);
    resetVendorMap(blockConfig);
  }
  renderLayers();
  renderBlockPalette();
}
function rebuildNodesForConfig(){
  nodesEl.innerHTML='';
  state.nodes.forEach(renderNode);
  refreshSelectionStyles();
  drawLinks();
}
const uid=()=> 'id'+Math.random().toString(36).slice(2,9);
const SNAP=10;
function canvasRect(){ const r=board.getBoundingClientRect(); return {x:r.left,y:r.top,w:r.width,h:r.height}; }
function wiresSize(){ const r=board.getBoundingClientRect(); wires.setAttribute('width', r.width); wires.setAttribute('height', r.height); wires.setAttribute('viewBox', `0 0 ${r.width} ${r.height}`); }
function save(){ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem(STORAGE); if(!raw) return false; const s=JSON.parse(raw); if(!s.nodes||!s.links) return false; state=s; clientName.value=state.client?.name||''; return true; }catch(e){ return false; } }

/* ======== Palette drag ======== */
let dragPal=null, palDX=0,palDY=0;
palHdr.addEventListener('mousedown',e=>{ dragPal=true; palDX=e.clientX - palette.offsetLeft; palDY=e.clientY - palette.offsetTop; document.addEventListener('mousemove',palMove); document.addEventListener('mouseup',palUp); });
function palMove(e){ if(!dragPal) return; palette.style.left=(e.clientX-palDX)+'px'; palette.style.top=(e.clientY-palDY)+'px'; }
function palUp(){ dragPal=false; document.removeEventListener('mousemove',palMove); document.removeEventListener('mouseup',palUp); }

/* ======== Blocks drag & drop ======== */
const PORTS=[{side:'top',pos:.2},{side:'top',pos:.8},{side:'bottom',pos:.2},{side:'bottom',pos:.8},{side:'left',pos:.5},{side:'right',pos:.5}];
function addNode(type,x,y){
  const vendorOptions=Array.isArray(VENDORS[type]) ? VENDORS[type] : [];
  const defaultVendor=vendorOptions.length>0 ? vendorOptions[0] : '';
  const n={id:uid(), type, title:type, vendor:defaultVendor, x:Math.round(x/SNAP)*SNAP, y:Math.round(y/SNAP)*SNAP};
  state.nodes.push(n); renderNode(n); save(); drawLinks();
}

function setupBlockInteractions(){
  blocksGrid.querySelectorAll('.block').forEach(b=>{
    b.setAttribute('draggable','true');
    b.addEventListener('dragstart',e=>{ try{ e.dataTransfer.setData('text/plain', b.dataset.type); }catch(err){} });
    b.addEventListener('click',()=>{
      const rect=canvasRect();
      const x=Math.max(20, rect.w/2 - 120);
      const y=Math.max(20, rect.h/2 - 60);
      addNode(b.dataset.type, x, y);
    });
  });
}
board.addEventListener('dragover',e=>{ e.preventDefault(); });
board.addEventListener('drop',e=>{ e.preventDefault(); const type=e.dataTransfer.getData('text/plain'); if(!type) return; const r=canvasRect(); addNode(type, e.clientX-r.x-100, e.clientY-r.y-30); });

/* ======== Node rendering & drag ======== */
function renderNode(n){
  const vendorOptions=Array.isArray(VENDORS[n.type]) ? VENDORS[n.type] : [];
  if(vendorOptions.length>0 && (!n.vendor || !vendorOptions.includes(n.vendor))){
    n.vendor=vendorOptions[0];
  }
  const el=document.createElement('div');
  el.className='node';
  el.dataset.id=n.id;
  el.style.left=n.x+'px';
  el.style.top=n.y+'px';
  el.innerHTML=`<div class="hdr"><span class="badge">${n.type}</span><div class="title" contenteditable="true">${n.title}</div><button class="nodeDel" title="Delete">×</button></div>
    <div class="body">
      ${vendorOptions.length?`<div class="vendorRow"><span style="font-size:12px;color:#64748b">Vendor</span>
        <img class="vendorLogo" alt="" style="display:none">
        <select class="vendorSel"></select>
        <input type="file" class="vendorUpload" accept="image/*" title="Optional logo">
      </div>`:''}
    </div>`;
  if(vendorOptions.length){
    const sel=el.querySelector('.vendorSel');
    sel.innerHTML=vendorOptions.map(v=>`<option value="${v}">${v}</option>`).join('');
    const current=vendorOptions.includes(n.vendor) ? n.vendor : vendorOptions[0];
    if(current){ sel.value=current; n.vendor=current; }
    sel.addEventListener('change',()=>{ n.vendor=sel.value; save(); });
    const up=el.querySelector('.vendorUpload');
    const img=el.querySelector('.vendorLogo');
    up.addEventListener('change',async e=>{
      const f=e.target.files?.[0];
      if(!f) return;
      const url=URL.createObjectURL(f);
      img.src=url;
      img.style.display='inline-block';
      n.vendorLogo=url;
      save();
    });
    if(n.vendorLogo){
      img.src=n.vendorLogo;
      img.style.display='inline-block';
    }
  }
  // ports
  const ports=document.createElement('div'); ports.className='ports';
  PORTS.forEach((p,i)=>{
    const dot=document.createElement('div');
    dot.className='port';
    dot.dataset.port=i;
    dot.dataset.side=p.side;
    dot.style.left=(p.side==='left'?0: p.side==='right'?'100%':(p.pos*100)+'%');
    dot.style.top=(p.side==='top'?0: p.side==='bottom'?'100%':(p.pos*100)+'%');
    dot.style.pointerEvents='auto';
    dot.title=`${p.side} ${(p.pos*100)|0}%`;
    dot.addEventListener('mouseenter',()=>{ if(temp) dot.classList.add('hit'); });
    dot.addEventListener('mouseleave',()=>{ dot.classList.remove('hit'); });
    dot.addEventListener('mousedown',ev=>{
      if(ev.button!==0) return;
      if(temp && temp.mode==='click'){ ev.preventDefault(); return; }
      ev.stopPropagation();
      beginWireFromPort(el, i, ev.clientX, ev.clientY, 'drag');
    });
    dot.addEventListener('click',ev=>{
      ev.stopPropagation();
      const nodeId=el.dataset.id;
      if(temp){
        if(temp.mode==='click'){
          if(temp.justArmed && temp.from===nodeId && temp.fromPort===i){
            temp.justArmed=false;
            return;
          }
          finalizeWire(nodeId, i);
        }
        return;
      }
      // clicked without prior drag (touch devices fallback)
      beginWireFromPort(el, i, ev.clientX, ev.clientY, 'click');
    });
    ports.appendChild(dot);
  });
  el.appendChild(ports);
  // drag
  let drag=null,dx=0,dy=0;
  el.addEventListener('mousedown',e=>{ if(e.target.closest('.port')) return; drag=el; const r=canvasRect(); dx=e.clientX-r.x-n.x; dy=e.clientY-r.y-n.y; document.addEventListener('mousemove',move); document.addEventListener('mouseup',up); });
  function move(e){ const r=canvasRect(); n.x=Math.round((e.clientX-r.x-dx)/SNAP)*SNAP; n.y=Math.round((e.clientY-r.y-dy)/SNAP)*SNAP; el.style.left=n.x+'px'; el.style.top=n.y+'px'; drawLinks(); }
  function up(){ document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); save(); }
  // delete block button
  el.querySelector('.nodeDel')?.addEventListener('click',()=>{ deleteNode(n.id); });

  nodesEl.appendChild(el);
  // selection handlers
  el.addEventListener('mousedown',e=>{ if(e.shiftKey && !e.target.closest('.port')){ toggleSelect(n.id,true); e.stopPropagation(); }});
  el.addEventListener('click',e=>{ if(!e.shiftKey && !e.target.closest('.port')){ selectSingle(n.id); }});
  updateNodeSelectedStyle(n.id);
}


/* ======== Selection + Lasso ======== */
const lasso=document.getElementById('lasso');
let lassoStart=null, lassoActive=false;
board.addEventListener('mousedown',e=>{ if(e.target!==board) return; if(!e.shiftKey) { clearSelection(); return; } const r=canvasRect(); lassoStart={x:e.clientX-r.x, y:e.clientY-r.y}; lassoActive=true; lasso.style.display='block'; lasso.style.left=lassoStart.x+'px'; lasso.style.top=lassoStart.y+'px'; lasso.style.width='0px'; lasso.style.height='0px'; document.addEventListener('mousemove',onLassoMove); document.addEventListener('mouseup',onLassoUp); });
function onLassoMove(e){ if(!lassoActive) return; const r=canvasRect(); const x=(e.clientX-r.x), y=(e.clientY-r.y); const left=Math.min(lassoStart.x,x), top=Math.min(lassoStart.y,y); const w=Math.abs(x-lassoStart.x), h=Math.abs(y-lassoStart.y); lasso.style.left=left+'px'; lasso.style.top=top+'px'; lasso.style.width=w+'px'; lasso.style.height=h+'px'; // hit-test
  const box={left,top,right:left+w,bottom:top+h};
  selected.clear();
  state.nodes.forEach(n=>{ const b=nodeBBox(n.id); const hit=!(b.left>box.right||b.left+b.w<box.left||b.top>box.bottom||b.top+b.h<box.top); if(hit) selected.add(n.id); });
  refreshSelectionStyles(); }
function onLassoUp(){ lassoActive=false; lasso.style.display='none'; document.removeEventListener('mousemove',onLassoMove); document.removeEventListener('mouseup',onLassoUp); }
function toggleSelect(id,on){ if(on){ selected.add(id);} else { selected.delete(id);} refreshSelectionStyles(); }
function selectSingle(id){ selected.clear(); selected.add(id); refreshSelectionStyles(); }
function clearSelection(){ selected.clear(); refreshSelectionStyles(); }
function updateNodeSelectedStyle(id){ const el=nodesEl.querySelector(`.node[data-id="${id}"]`); if(!el) return; el.classList.toggle('selected', selected.has(id)); }
function refreshSelectionStyles(){ state.nodes.forEach(n=>updateNodeSelectedStyle(n.id)); }

/* ======== Wires ======== */
function ensureDefs(){ let defs=wires.querySelector('defs'); if(!defs){ defs=document.createElementNS('http://www.w3.org/2000/svg','defs'); wires.appendChild(defs);} defs.innerHTML=`<marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto" markerUnits="strokeWidth"><path d="M0 0 L10 5 L0 10 z" fill="context-stroke"></path></marker>`; }
function nodeBBox(id){ const el=nodesEl.querySelector(`.node[data-id="${id}"]`); const r=el.getBoundingClientRect(); const br=board.getBoundingClientRect(); return {left:r.left-br.left, top:r.top-br.top, w:r.width, h:r.height}; }
function portPoint(bbox, side, pos){ const pad=6; if(side==='top') return {x=bbox.left + bbox.w*pos, y=bbox.top - pad}; if(side==='bottom') return {x=bbox.left + bbox.w*pos, y=bbox.top + bbox.h + pad}; if(side==='left') return {x=bbox.left - pad, y=bbox.top + bbox.h*pos}; if(side==='right') return {x=bbox.left + bbox.w + pad, y=bbox.top + bbox.h*pos}; return {x=bbox.left + bbox.w + pad, y=bbox.top + bbox.h/2}; }
function getObstacles(excludeIds=[]){ return state.nodes.filter(n=>!excludeIds.includes(n.id)).map(n=>{ const b=nodeBBox(n.id); return {left:b.left-10,right:b.left+b.w+10,top:b.top-10,bottom:b.top+b.h+10}; }); }
function segHitsRectH(y,x1,x2,R){ const L=Math.min(x1,x2), H=Math.max(x1,x2); return (y>=R.top && y<=R.bottom) && !(H<R.left || L>R.right); }
function segHitsRectV(x,y1,y2,R){ const T=Math.min(y1,y2), B=Math.max(y1,y2); return (x>=R.left && x<=R.right) && !(B<R.top || T>R.bottom); }
function clearH(y,x1,x2,obs){ return !obs.some(R=>segHitsRectH(y,x1,x2,R)); }
function clearV(x,y1,y2,obs){ return !obs.some(R=>segHitsRectV(x,y1,y2,R)); }
function route(sx,sy,tx,ty,exclude=[]){ const obs=getObstacles(exclude); if(clearH(sy,sx,tx,obs)&&clearV(tx,sy,ty,obs)) return [[sx,sy],[tx,sy],[tx,ty]]; if(clearV(sx,sy,ty,obs)&&clearH(ty,sx,tx,obs)) return [[sx,sy],[sx,ty],[tx,ty]]; const EYS=[sy,ty]; obs.forEach(R=>{EYS.push(R.top-14,R.bottom+14)}); EYS.sort((a,b)=>a-b); for(const y of EYS){ if(clearH(y,Math.min(sx,tx),Math.max(sx,tx),obs)&&clearV(sx,sy,y,obs)&&clearV(tx,y,ty,obs)) return [[sx,sy],[sx,y],[tx,y],[tx,ty]]; } const EXS=[sx,tx]; obs.forEach(R=>{EXS.push(R.left-14,R.right+14)}); EXS.sort((a,b)=>a-b); for(const x of EXS){ if(clearV(x,Math.min(sy,ty),Math.max(sy,ty),obs)&&clearH(sy,sx,x,obs)&&clearH(ty,x,tx,obs)) return [[sx,sy],[x,sy],[x,ty],[tx,ty]]; } const farR=Math.max(...obs.map(r=>r.right).concat([sx,tx]))+40; if(clearH(sy,sx,farR,obs)&&clearH(ty,farR,tx,obs)&&clearV(farR,sy,ty,obs)) return [[sx,sy],[farR,sy],[farR,ty],[tx,ty]]; return [[sx,sy],[tx,sy],[tx,ty]]; }
function rounded(points){ const r=6; if(points.length<2) return ''; let d=`M ${points[0][0]} ${points[0][1]}`; for(let i=1;i<points.length;i++){ const [x,y]=points[i]; if(i<points.length-1){ const [nx,ny]=points[i+1]; const ex=x-(x!==points[i-1][0]?Math.sign(x-points[i-1][0])*r:0); const ey=y-(y!==points[i-1][1]?Math.sign(y-points[i-1][1])*r:0); d+=` L ${ex} ${ey} Q ${x} ${y} ${x+(x!==nx?Math.sign(nx-x)*r:0)} ${y+(y!==ny?Math.sign(ny-y)*r:0)}`; } else d+=` L ${x} ${y}`;} return d; }

function drawLinks(){ wiresSize(); ensureDefs(); wires.innerHTML=wires.innerHTML; state.links.forEach(link=>{ const A=nodeBBox(link.from); const B=nodeBBox(link.to); const fp=PORTS[link.fromPort||1]; const tp=PORTS[link.toPort||0]; const s=portPoint(A,fp.side,fp.pos); const t=portPoint(B,tp.side,tp.pos); const d=rounded(route(s.x,s.y,t.x,t.y,[link.from,link.to])); const path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d',d); path.setAttribute('class',`link ${link.style==='dashed'?'dashed':''}`); if(link.arrows==='start'||link.arrows==='both') path.setAttribute('marker-start','url(#arrow)'); if(link.arrows==='end'||link.arrows==='both') path.setAttribute('marker-end','url(#arrow)'); path.dataset.id=link.id; path.style.pointerEvents='stroke'; path.addEventListener('click',e=>{ e.stopPropagation(); openLinkbar(e.clientX,e.clientY,link.id); }); wires.appendChild(path); }); const ghost=document.getElementById('tempPath'); if(ghost) wires.appendChild(ghost); }

function deleteNode(id){ // remove node and attached links
  const idx=state.nodes.findIndex(n=>n.id===id); if(idx<0) return; state.nodes.splice(idx,1);
  state.links = state.links.filter(l=> l.from!==id && l.to!==id );
  nodesEl.querySelector(`.node[data-id="${id}"]`)?.remove();
  drawLinks(); save(); }

// linkbar actions
function openLinkbar(x,y,id){ linkbar.style.display='flex'; linkbar.style.left=(x+8)+'px'; linkbar.style.top=(y+8)+'px'; linkbar.dataset.linkId=id; }
linkbar.addEventListener('click',e=>{ const act=e.target?.dataset?.act; if(!act) return; const id=linkbar.dataset.linkId; const L=state.links.find(l=>l.id===id); if(!L) return; if(act==='toggle'){ L.style=L.style==='dashed'?'solid':'dashed'; } else if(['none','start','end','both'].includes(act)){ L.arrows= act==='none'? undefined : act; } else if(act==='delete'){ state.links = state.links.filter(l=>l.id!==id); linkbar.style.display='none'; }
  drawLinks(); save(); });
document.addEventListener('click',e=>{ if(!e.target.closest('.linkbar')) linkbar.style.display='none'; });

// === Visio-like connection flow ===
let temp=null;
function beginWireFromPort(nodeEl, portIdx, clientX, clientY, mode){
  const nodeId=nodeEl.dataset.id;
  temp={from:nodeId, fromPort:portIdx, mode, startX:clientX, startY:clientY, moved:false, justArmed:mode==='click'};
  board.classList.add('connecting');
  updateTempPath(clientX, clientY);
}
function updateTempPath(clientX, clientY){
  if(!temp) return;
  const br=board.getBoundingClientRect();
  const mx=clientX-br.left;
  const my=clientY-br.top;
  const A=nodeBBox(temp.from);
  const fp=PORTS[temp.fromPort];
  const s=portPoint(A,fp.side,fp.pos);
  const pts=route(s.x,s.y,mx,my,[]);
  const d=rounded(pts);
  let p=document.getElementById('tempPath');
  if(!p){ p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.id='tempPath'; p.setAttribute('class','temp'); wires.appendChild(p); }
  p.setAttribute('d',d);
  if(!temp.moved && (Math.abs(clientX-temp.startX)>2 || Math.abs(clientY-temp.startY)>2)) temp.moved=true;
}
function finalizeWire(nodeId, portIdx){
  if(!temp) return;
  if(temp.from===nodeId && temp.fromPort===portIdx){ cancelWire(); return; }
  state.links.push({id:uid(), from:temp.from, to:nodeId, fromPort:temp.fromPort, toPort:portIdx, style:'solid', arrows:undefined});
  save();
  drawLinks();
  cancelWire();
}
function cancelWire(){
  document.getElementById('tempPath')?.remove();
  board.classList.remove('connecting');
  document.querySelectorAll('.port.hit').forEach(p=>p.classList.remove('hit'));
  temp=null;
}

function followWire(e){ if(temp) updateTempPath(e.clientX, e.clientY); }
window.addEventListener('mousemove', followWire, {passive:true});
window.addEventListener('mouseup',e=>{
  if(!temp) return;
  if(temp.mode==='drag'){
    if(!temp.moved){
      temp.mode='click';
      temp.justArmed=true;
      return;
    }
    const portEl=(e.target && typeof e.target.closest==='function') ? e.target.closest('.port') : null;
    if(portEl){
      const nodeEl=portEl.closest('.node');
      finalizeWire(nodeEl.dataset.id, parseInt(portEl.dataset.port,10));
    } else {
      cancelWire();
    }
  }
});
board.addEventListener('click',e=>{
  if(!temp || temp.mode!=='click') return;
  const target=e.target;
  const hasPort=(target && typeof target.closest==='function') ? target.closest('.port') : null;
  if(!hasPort) cancelWire();
});
window.addEventListener('keydown',e=>{ if(e.key==='Escape' && temp){ cancelWire(); }});

/* ======== Align / Distribute ======== */
function getSelNodes(){ return state.nodes.filter(n=>selected.has(n.id)); }
alignLeft.addEventListener('click',()=>{ const ns=getSelNodes(); if(ns.length<2) return; const x=Math.min(...ns.map(n=>n.x)); ns.forEach(n=>{ n.x=x; const el=nodesEl.querySelector(`.node[data-id="${n.id}"]`); el.style.left=x+'px'; }); drawLinks(); save(); });
alignTop.addEventListener('click',()=>{ const ns=getSelNodes(); if(ns.length<2) return; const y=Math.min(...ns.map(n=>n.y)); ns.forEach(n=>{ n.y=y; const el=nodesEl.querySelector(`.node[data-id="${n.id}"]`); el.style.top=y+'px'; }); drawLinks(); save(); });
alignVCenter.addEventListener('click',()=>{ const ns=getSelNodes(); if(ns.length<2) return; const mid=Math.round((Math.min(...ns.map(n=>n.y)) + Math.max(...ns.map(n=>n.y)))/2/SNAP)*SNAP; ns.forEach(n=>{ const el=nodesEl.querySelector(`.node[data-id="${n.id}"]`); n.y=mid; el.style.top=mid+'px'; }); drawLinks(); save(); });
alignHCenter.addEventListener('click',()=>{ const ns=getSelNodes(); if(ns.length<2) return; const mid=Math.round((Math.min(...ns.map(n=>n.x)) + Math.max(...ns.map(n=>n.x)))/2/SNAP)*SNAP; ns.forEach(n=>{ const el=nodesEl.querySelector(`.node[data-id="${n.id}"]`); n.x=mid; el.style.left=mid+'px'; }); drawLinks(); save(); });
distH.addEventListener('click',()=>{ const ns=getSelNodes(); if(ns.length<3) return; ns.sort((a,b)=>a.x-b.x); const left=ns[0].x, right=ns[ns.length-1].x; const step=(right-left)/(ns.length-1); ns.forEach((n,i)=>{ n.x=Math.round((left+i*step)/SNAP)*SNAP; const el=nodesEl.querySelector(`.node[data-id="${n.id}"]`); el.style.left=n.x+'px'; }); drawLinks(); save(); });
distV.addEventListener('click',()=>{ const ns=getSelNodes(); if(ns.length<3) return; ns.sort((a,b)=>a.y-b.y); const top=ns[0].y, bottom=ns[ns.length-1].y; const step=(bottom-top)/(ns.length-1); ns.forEach((n,i)=>{ n.y=Math.round((top+i*step)/SNAP)*SNAP; const el=nodesEl.querySelector(`.node[data-id="${n.id}"]`); el.style.top=n.y+'px'; }); drawLinks(); save(); });

/* ======== Export/Import ======== */
exportJSON.addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='process-flow.json'; a.click(); URL.revokeObjectURL(url); });
importJSON.addEventListener('click',()=>importJSONFile.click());
importJSONFile.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const s=JSON.parse(await f.text()); if(!Array.isArray(s.nodes)||!Array.isArray(s.links)) throw 0; state=s; clientName.value=state.client?.name||''; rebuildNodesForConfig(); save(); }catch{ alert('Invalid JSON'); }});

// PDF via print() com layout limpo
exportPDF.addEventListener('click',()=>{ window.print(); });

// SVG/PNG export (snapshot)
function buildSVGSnapshot(){
  const r=board.getBoundingClientRect();
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  svg.setAttribute('xmlns',svgNS); svg.setAttribute('width',r.width); svg.setAttribute('height',r.height); svg.setAttribute('viewBox',`0 0 ${r.width} ${r.height}`);
  // background
  const bg=document.createElementNS(svgNS,'rect'); bg.setAttribute('x',0); bg.setAttribute('y',0); bg.setAttribute('width',r.width); bg.setAttribute('height',r.height); bg.setAttribute('fill','#ffffff'); svg.appendChild(bg);
  // layers
  const dashed=(y)=>{ const l=document.createElementNS(svgNS,'line'); l.setAttribute('x1',0); l.setAttribute('x2',r.width); l.setAttribute('y1',y); l.setAttribute('y2',y); l.setAttribute('stroke','#5e87b5'); l.setAttribute('stroke-width','2'); l.setAttribute('stroke-dasharray','8 8'); return l; };
  layersConfig.forEach(layer=>{
    const pos=Math.min(1, Math.max(0, layer.position));
    const y=r.height*pos;
    svg.appendChild(dashed(y));
    if(layer.label){
      const labelWidth=Math.max(36, layer.label.length*8+20);
      const labelHeight=24;
      const labelX=16;
      const labelY=Math.max(6, y-labelHeight);
      const bubble=document.createElementNS(svgNS,'rect');
      bubble.setAttribute('x', labelX);
      bubble.setAttribute('y', labelY);
      bubble.setAttribute('rx','12');
      bubble.setAttribute('ry','12');
      bubble.setAttribute('width', labelWidth);
      bubble.setAttribute('height', labelHeight);
      bubble.setAttribute('fill','#ffffff');
      bubble.setAttribute('stroke','#d7dfef');
      svg.appendChild(bubble);
      const text=document.createElementNS(svgNS,'text');
      text.setAttribute('x', labelX + labelWidth/2);
      text.setAttribute('y', labelY + labelHeight - 7);
      text.setAttribute('fill','#272e51');
      text.setAttribute('font-size','12');
      text.setAttribute('font-weight','700');
      text.setAttribute('text-anchor','middle');
      text.textContent=layer.label;
      svg.appendChild(text);
    }
  });
  // links
  const defs=document.createElementNS(svgNS,'defs'); const m=document.createElementNS(svgNS,'marker'); m.setAttribute('id','arrow'); m.setAttribute('viewBox','0 0 10 10'); m.setAttribute('refX','10'); m.setAttribute('refY','5'); m.setAttribute('markerWidth','8'); m.setAttribute('markerHeight','8'); m.setAttribute('orient','auto'); m.setAttribute('markerUnits','strokeWidth'); const mp=document.createElementNS(svgNS,'path'); mp.setAttribute('d','M0 0 L10 5 L0 10 z'); mp.setAttribute('fill','#5e87b5'); m.appendChild(mp); defs.appendChild(m); svg.appendChild(defs);
  state.links.forEach(link=>{ const A=nodeBBox(link.from); const B=nodeBBox(link.to); const fp=PORTS[link.fromPort||1]; const tp=PORTS[link.toPort||0]; const s=portPoint(A,fp.side,fp.pos); const t=portPoint(B,tp.side,tp.pos); const pts=route(s.x,s.y,t.x,t.y,[link.from,link.to]); const d=rounded(pts); const p=document.createElementNS(svgNS,'path'); p.setAttribute('d',d); p.setAttribute('fill','none'); p.setAttribute('stroke','#5e87b5'); p.setAttribute('stroke-width','2'); if(link.style==='dashed') p.setAttribute('stroke-dasharray','8 8'); if(link.arrows==='start'||link.arrows==='both') p.setAttribute('marker-start','url(#arrow)'); if(link.arrows==='end'||link.arrows==='both') p.setAttribute('marker-end','url(#arrow)'); svg.appendChild(p); });
  // nodes
  state.nodes.forEach(n=>{ const b=nodeBBox(n.id); const g=document.createElementNS(svgNS,'g'); const rect=document.createElementNS(svgNS,'rect'); rect.setAttribute('x',b.left); rect.setAttribute('y',b.top); rect.setAttribute('rx','12'); rect.setAttribute('ry','12'); rect.setAttribute('width',b.w); rect.setAttribute('height',b.h); rect.setAttribute('fill','#fff'); rect.setAttribute('stroke','#dde3ef'); g.appendChild(rect);
    const badge=document.createElementNS(svgNS,'rect'); badge.setAttribute('x',b.left+10); badge.setAttribute('y',b.top+10); badge.setAttribute('rx','6'); badge.setAttribute('ry','6'); badge.setAttribute('width','70'); badge.setAttribute('height','18'); badge.setAttribute('fill','#5e87b5'); g.appendChild(badge);
    const badgeTxt=document.createElementNS(svgNS,'text'); badgeTxt.setAttribute('x',b.left+45); badgeTxt.setAttribute('y',b.top+23); badgeTxt.setAttribute('fill','#fff'); badgeTxt.setAttribute('font-size','11'); badgeTxt.setAttribute('font-weight','700'); badgeTxt.setAttribute('text-anchor','middle'); badgeTxt.textContent=n.type; g.appendChild(badgeTxt);
    const title=document.createElementNS(svgNS,'text'); title.setAttribute('x',b.left+90); title.setAttribute('y',b.top+24); title.setAttribute('fill','#0f172a'); title.setAttribute('font-size','13'); title.setAttribute('font-weight','700'); title.textContent=n.title; g.appendChild(title);
    svg.appendChild(g); });
  return svg;
}
exportSVG.addEventListener('click',()=>{ const svg=buildSVGSnapshot(); const blob=new Blob([new XMLSerializer().serializeToString(svg)],{type:'image/svg+xml'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='process-flow.svg'; a.click(); URL.revokeObjectURL(url); });
exportPNG.addEventListener('click',()=>{ const svg=buildSVGSnapshot(); const xml=new XMLSerializer().serializeToString(svg); const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml); const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); c.width=svg.getAttribute('width'); c.height=svg.getAttribute('height'); const ctx=c.getContext('2d'); ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,c.width,c.height); ctx.drawImage(img,0,0); c.toBlob(b=>{ const dl=URL.createObjectURL(b); const a=document.createElement('a'); a.href=dl; a.download='process-flow.png'; a.click(); URL.revokeObjectURL(dl); },'image/png'); }; img.src=url; });

/* ======== Clear Board ======== */
clearBoardBtn.addEventListener('click',()=>{ if(!confirm('Clear the entire board? This action removes all blocks and connections.')) return; state.nodes=[]; state.links=[]; nodesEl.innerHTML=''; drawLinks(); save(); });

/* ======== Client branding ======== */
clientName.addEventListener('input',()=>{ state.client.name=clientName.value.trim(); save(); });
clientLogo.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); state.client.logo=url; // watermark
  const existing=document.getElementById('clientMark'); if(existing) existing.remove();
  const img=document.createElement('img'); img.id='clientMark'; img.src=url; img.style.cssText='position:absolute;right:16px;top:12px;height:28px;object-fit:contain;z-index:9'; board.appendChild(img); save(); });

/* ======== Boot ======== */
(async function init(){
  renderLayers();
  renderBlockPalette();
  await loadExternalConfig();
  if(load()){
    rebuildNodesForConfig();
  } else {
    drawLinks();
  }
})();

// Resize
window.addEventListener('resize', drawLinks);
// Keyboard delete selected nodes
window.addEventListener('keydown',e=>{ if((e.key==='Delete'||e.key==='Backspace') && selected.size>0){ [...selected].forEach(id=>deleteNode(id)); selected.clear(); refreshSelectionStyles(); }});
resetView.addEventListener('click',()=>{ palette.style.top='100px'; palette.style.right='16px'; });
</script>
</body>
</html>